```js
/*
 * @Author: 开黑店养只猫
 * @Date: 2019-05-29 10:15:03 
 * @Desc: 小程序配置文件
 * @name: 医院小程序
 * @Last Modified time: 2019-05-29 10:15:03 
 */
const wechatName = '医院小程序';
const host = 'host';

var config = {
    // 小程序请求接口
    host,
    // 微信授权登录
    login: `${host}login`,
    // 获取openid
    getOpenid: `${host}getOpenid`,
    // 进入首页加载
    init: `${host}init`,
};


/**
 * 小程序主动更新
 */
function updateManager() {
    // 获取小程序更新机制兼容
    if (wx.canIUse('getUpdateManager')) {
        const updateManager = wx.getUpdateManager()
        updateManager.onCheckForUpdate(function(res) {
            // 请求完新版本信息的回调
            if (res.hasUpdate) {
                updateManager.onUpdateReady(function() {
                    wx.showModal({
                        title: '更新提示',
                        content: '新版本已经准备好，是否重启应用？',
                        showCancel: false,
                        success: function(res) {
                            if (res.confirm) {
                                // 新的版本已经下载好，调用 applyUpdate 应用新版本并重启
                                updateManager.applyUpdate()
                            }
                        }
                    })
                })
                updateManager.onUpdateFailed(function() {
                    // 新的版本下载失败
                    wx.showModal({
                        title: '已经有新版本了哟~',
                        showCancel: false,
                        content: '请在微信 “发现-小程序” 页删除当前小程序，重新通过小程序名称搜索打开使用最新版本',
                    })
                })
            }
        })
    } else {
        // 如果希望用户在最新版本的客户端上体验您的小程序，可以这样子提示
        wx.showModal({
            title: '提示',
            showCancel: false,
            content: '当前微信版本过低,请升级到最新微信版本。'
        })
    }
}


function log(obj) {
    if (typeof obj === 'string') {
        console.log("%c " + obj, "color:#0a0;font-size:3em;");
    } else {
        console.log(obj);
    }
}


function __args() {
    var setting = {};
    if (arguments.length === 1 && typeof arguments[0] !== 'string') {
        setting = arguments[0];
    } else {
        setting.url = arguments[0];
        if (typeof arguments[1] === 'object') {
            setting.data = arguments[1];
            setting.success = arguments[2];
        } else {
            setting.success = arguments[1];
        }
    }
    if (setting.url.indexOf('http://') !== 0) {

        setting.url = setting.url;
    }
    return setting;
}

function __json(method, setting) {
    setting.method = method;
    setting.header = {
        'content-type': 'application/x-www-form-urlencoded'
    };
    wx.request(setting);
}


function _get() { // get请求
    __json('GET', __args.apply(this, arguments));
}

function _post() { //post请求
    __json('POST', __args.apply(this, arguments));
}

function to_date(phpstr, type) { // php时间戳转日期
    var str = parseInt(phpstr) * 1000;
    var newDate = new Date(str);
    var year = newDate.getUTCFullYear(); //取年份
    var month = (newDate.getUTCMonth() + 1) >= 10 ? (newDate.getUTCMonth() + 1) : '0' + (newDate.getUTCMonth() + 1); //取月份
    var nowday = newDate.getUTCDate() >= 10 ? newDate.getUTCDate() : '0' + newDate.getUTCDate(); //取天数
    var hours = newDate.getHours() >= 10 ? newDate.getHours() : '0' + newDate.getHours(); //取小时
    var minutes = newDate.getMinutes() >= 10 ? newDate.getMinutes() : '0' + newDate.getMinutes(); //取分钟
    var seconds = newDate.getSeconds() >= 10 ? newDate.getSeconds() : '0' + newDate.getSeconds(); //取秒
    var newdatastr = '';
    if (type == 1) { //年月日
        newdatastr = year + "-" + month + "-" + nowday;
    }
    if (type == 2) { //时分秒
        newdatastr = hours + ":" + minutes + ":" + seconds;
    }
    if (type == 3) { //年月日时分秒
        newdatastr = year + "-" + month + "-" + nowday + " " + hours + ":" + minutes + ":" + seconds;
    }
    return newdatastr;
}

function removeAllSpace(str) { //删除空格
    return str.replace(/\s+/g, "");
}

function random(Max, Min) { // 随机数
    var Range = Max - Min;
    var Rand = Math.random();
    return (Min + Math.round(Rand * Range));
}


function showSuccess(msg, callback) { //显示成功提示框
    wx.showToast({
        title: msg,
        icon: 'success',
        mask: true,
        duration: 1500,
        success: function() {
            callback && (setTimeout(function() {
                callback();
            }, 1500));
        }
    });
}

function showError(msg, callback) { //显示 showModal 提示框
    wx.showModal({
        title: '微信提示',
        content: msg,
        showCancel: false,
        success: function(res) {
            callback && callback();
        }
    });
}


function urlEncode(data) { //对象转URL
    var _result = [];
    for (var key in data) {
        var value = data[key];
        if (value.constructor == Array) {
            value.forEach(function(_value) {
                _result.push(key + "=" + _value);
            });
        } else {
            _result.push(key + '=' + value);
        }
    }
    return _result.join('&');
}

function alert(title) { // 提示
    wx.showToast({
        title: title,
        icon: 'none'
    })
}

function sequenceTasks(tasks) { //图片上传-顺序处理函数  
    //记录返回值
    function recordValue(results, value) {
        results.push(value);
        return results;
    }
    let pushValue = recordValue.bind(null, []);
    let promise = Promise.resolve();
    // 处理tasks数组中的每个函数对象
    for (let i = 0; i < tasks.length; i++) {
        let task = tasks[i];
        promise = promise.then(task).then(pushValue);
    }
    return promise;
}

function uploadFile(num, success) { //上传照片 上传数量  回调函数
    var imgindex = 0;
    var imgarr = []; //上传保存图片路径
    wx.chooseImage({
        count: num ? num : 1,
        sizeType: ['original', 'compressed'],
        sourceType: ['album', 'camera'],
        success(res) {
            const tempFilePaths = res.tempFilePaths;
            // console.log(tempFilePaths);
            // return false;
            wx.showLoading({
                title: "上传中"
            });
            //函数数组，每个函数的返回值是一个promise对象
            let promiseFuncArr = [];
            //图片地址数组
            let imageList = [];
            //将图片地址的上传的函数加入到promiseFuncArr数组中
            for (let i = 0; i < tempFilePaths.length; i++) {
                let promiseTemp = function() {
                    return new Promise((resolve, reject) => {
                        //微信图片上传
                        wx.uploadFile({
                            url: `${config.uploadFile}`,
                            filePath: tempFilePaths[i],
                            name: 'upfile',
                            success: function(res) {
                                //可以对res进行处理，然后resolve返回
                                resolve(res);
                            },
                            fail: function(error) {
                                reject(error);
                            },
                            complete: function(res) {},
                        })
                    });
                };
                promiseFuncArr.push(promiseTemp)
            }

            sequenceTasks(promiseFuncArr).then((result) => {
                console.log(result);
                result.map(v => {
                    imgarr.push(JSON.parse(v.data).url);
                });
                wx.hideLoading();
                success && success(imgarr);
                //对返回的result数组进行处理
            });
        }
    })
}

function getsys(key) { //获取本地存储
    return wx.getStorageSync(key);
}

function setsys(key, value) { //设置本地存储
    wx.setStorageSync(key, value);
}

function delsys(key) { //删除本地存储
    wx.removeStorageSync(key);
}

function gourl(url) { //跳转到指定页面
    if (!url || url.length == 0) {
        return false;
    }
    wx.navigateTo({
        url: url
    });
}


function gotab(url) { //跳转tabBar页面
    if (!url || url.length == 0) {
        return false;
    }
    wx.switchTab({
        url: url
    });
}
/**
 *  把html转义成HTML实体字符
 */
function htmlEncode(str) {
    var s = "";
    if (str.length === 0) {
        return "";
    }
    s = str.replace(/&/g, "&amp;");
    s = s.replace(/</g, "&lt;");
    s = s.replace(/>/g, "&gt;");
    s = s.replace(/ /g, "&nbsp;");
    s = s.replace(/\'/g, "&#39;"); //IE下不支持实体名称
    s = s.replace(/\"/g, "&quot;");
    return s;
}


/**
 *  转义字符还原成html字符
 */
function htmlRestore(str) {
    var s = "";
    if (str.length === 0) {
        return "";
    }
    s = str.replace(/&amp;/g, "&");
    s = s.replace(/&lt;/g, "<");
    s = s.replace(/&gt;/g, ">");
    s = s.replace(/&nbsp;/g, " ");
    s = s.replace(/&#39;/g, "\'");
    s = s.replace(/&quot;/g, "\"");
    return s;
}
/**
 * 去掉所有的html标签和&nbsp;之类的特殊符合
 */
function deleteHtmlTag(str) {
    str = str.replace(/<[^>]+>|&[^>]+;/g, "").trim();
    return str;
}

// 微信小程序rich-text富文本图片自适应处理
function richtext(data) {
    var result = data;
    result = result.replace(/\<img/gi, '<img style="max-width:100%;height:auto" ');
    result = result.replace(/section/gi, 'div');
    return result;
}
// 获取 自定义  data 属性
function tapinfo(e) {
    return e.currentTarget.dataset;
}
/**
 * 获取php 时间戳 几小时之前
 */
function getDateDiff(dateStr) {
    var publishTime = parseInt(dateStr) * 1000,
        d_seconds,
        d_minutes,
        d_hours,
        d_days,
        timeNow = parseInt(new Date().getTime()),
        d,

        date = new Date(publishTime),
        Y = date.getFullYear(),
        M = date.getMonth() + 1,
        D = date.getDate(),
        H = date.getHours(),
        m = date.getMinutes(),
        s = date.getSeconds();



    //小于10的在前面补0
    if (M < 10) {
        M = '0' + M;
    }
    if (D < 10) {
        D = '0' + D;
    }
    if (H < 10) {
        H = '0' + H;
    }
    if (m < 10) {
        m = '0' + m;
    }
    if (s < 10) {
        s = '0' + s;
    }
    d = timeNow - publishTime;
    var miao = 1000;
    var minute = miao * 60;
    var hour = minute * 60;
    var day = hour * 24;
    var halfamonth = day * 15;
    var month = day * 30;

    d_days = parseInt(d / day);
    d_hours = parseInt(d / hour);
    d_minutes = parseInt(d / minute);
    d_seconds = parseInt(d / miao);

    if (d_days > 0 && d_days < 7) {
        return d_days + '天前';
    } else if (d_days <= 0 && d_hours > 0) {
        return d_hours + '小时前';
    } else if (d_hours <= 0 && d_minutes > 0) {
        return d_minutes + '分钟前';
    } else if (d_seconds < 60) {
        if (d_seconds <= 0) {
            return '刚刚发表';
        } else {
            return d_seconds + '秒前';
        }
    } else if (d_days >= 7 && d_days < 30) {
        return M + '-' + D + ' ' + H + ':' + m;
    } else if (d_days >= 30) {
        return Y + '-' + M + '-' + D + '' + H + ':' + m;
    }
}

function islogin() {
    //	检测用户是否授权
    wx.getSetting({
        success(res) {
            if (!res.authSetting['scope.userInfo']) {
                wx.navigateTo({
                    url: '/pages/login/login'
                });
            }
        }
    })
},

function getOpenid(cb) { //	获取openid
        let app = this;
        wx.login({
            success(res) {
                if (res.code) {
                    app._post(app.config.getOpenid, {
                        code: res.code
                    }, function(res) {
                        if (res.data.code == 0) {
                            wx.setStorageSync('openid', res.data.data.openid);
                            // wx.setStorageSync('userid', res.data.data.userid)
                            cb && cb();
                        }
                    });
                } else {
                    app.getOpenid();
                    console.log('登录失败！' + res.errMsg)
                }
            }
        });
    }
module.exports = {
    config: config,
    to_date: to_date,
    removeAllSpace: removeAllSpace,
    random: random,
    urlEncode: urlEncode,
    showSuccess: showSuccess,
    showError: showError,
    alert: alert,
    uploadFile: uploadFile,
    getsys: getsys,
    setsys: setsys,
    delsys: delsys,
    gourl: gourl,
    _get: _get,
    _post: _post,
    gotab: gotab,
    htmlRestore: htmlRestore,
    htmlEncode: htmlEncode,
    log: log,
    tapinfo: tapinfo,
    richtext: richtext,
    getDateDiff: getDateDiff,
    deleteHtmlTag: deleteHtmlTag,
    updateManager: updateManager,
    islogin:islogin,
    getOpenid:getOpenid
}
```